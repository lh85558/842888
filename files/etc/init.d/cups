#!/bin/sh /etc/rc.common
# CUPS打印服务启动脚本
# 为THDN打印服务器定制

START=95
STOP=10

USE_PROCD=1
PROG=/usr/sbin/cupsd
CONF_FILE=/etc/cups/cupsd.conf
PID_FILE=/var/run/cupsd.pid

start_service() {
    # 创建必要的目录
    mkdir -p /var/log/cups
    mkdir -p /var/spool/cups
    mkdir -p /var/spool/cups/tmp
    mkdir -p /var/spool/cups/cache
    
    # 设置正确的权限
    chmod 755 /var/log/cups
    chmod 755 /var/spool/cups
    chmod 1777 /var/spool/cups/tmp
    
    # 创建CUPS用户和组（如果不存在）
    grep -q "^cups:" /etc/group || echo "cups:x:100:cups" >> /etc/group
    grep -q "^cups:" /etc/passwd || echo "cups:x:100:100:CUPS User:/var/spool/cups:/bin/false" >> /etc/passwd
    
    procd_open_instance
    procd_set_param command $PROG -c $CONF_FILE -f
    procd_set_param respawn
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_close_instance
    
    logger -t cups "CUPS打印服务已启动"
}

stop_service() {
    # 停止CUPS服务
    killall cupsd 2>/dev/null || true
    logger -t cups "CUPS打印服务已停止"
}

reload_service() {
    # 重新加载CUPS配置
    killall -HUP cupsd 2>/dev/null || true
    logger -t cups "CUPS配置已重新加载"
}

service_triggers() {
    procd_add_reload_trigger "cups"
}

validate_cups_config() {
    # 验证CUPS配置文件
    if [ -f "$CONF_FILE" ]; then
        # 基本语法检查
        grep -q "Listen" "$CONF_FILE" && return 0
    fi
    return 1
}
